<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Configuration Modern'home</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    * { box-sizing:border-box; margin:0; padding:0 }
    html, body { height:100%; font-family:sans-serif; background:#f0f2f5 }

    .fixed-price {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 1000;
      text-align: center;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }

    .fixed-price.visible {
      transform: translateY(0);
    }

    .fixed-price-label {
      font-size: 1rem;
      color: #666;
      margin-right: 1rem;
    }

    .fixed-price-amount {
      font-size: 1.5rem;
      font-weight: bold;
      color: #1a202c;
    }

    #configurator {
      display: grid;
      grid-template-columns: 2fr 1fr;
      height: 100vh;
      gap: 1rem;
      padding: 1rem;
    }

    .viewer-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    model-viewer {
      flex: 5;
      width: 100%;
      height: 100%;
      background: #dddddd;
      pointer-events: all;
      touch-action: none;
    }

    #energy-summary {
      flex: 2;
      background: #fff;
      border-top: 1px solid #eee;
      overflow-y: auto;
      padding: 1rem;
    }

    #energy-summary h3 {
      font-size: 1rem;
      color: #222;
      margin-bottom: 1rem;
    }

    #energy-visual {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 2rem;
      margin-bottom: 1rem;
    }

    .house-container {
      width: 120px;
      height: 120px;
    }

    .house-svg {
      width: 100%;
      height: 100%;
      transition: all 0.6s ease-in-out;
    }

    .energy-rating-scale {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .rating-bar {
      display: flex;
      align-items: center;
      height: 24px;
      padding: 0 12px;
      color: white;
      opacity: 0.7;
      transition: all 0.3s ease;
      clip-path: polygon(0 0, calc(100% - 12px) 0, 100% 50%, calc(100% - 12px) 100%, 0 100%);
      width: 200px;
    }

    .rating-bar.active {
      opacity: 1;
      width: 220px;
      transform: translateX(8px);
    }

    .rating-label {
      font-weight: bold;
      margin-right: 8px;
      min-width: 25px;
    }

    .rating-value {
      font-size: 0.9em;
    }

    .rating-A-plus { background-color: #1B5E20; }
    .rating-A { background-color: #2E7D32; }
    .rating-B { background-color: #388E3C; }
    .rating-C { background-color: #8BC34A; }
    .rating-D { background-color: #FFEB3B; color: #000; }
    .rating-E { background-color: #FFC107; color: #000; }
    .rating-F { background-color: #FF9800; }
    .rating-G { background-color: #F44336; }

    .energy-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: .25rem;
    }

    .energy-bar {
      width: 100%;
      height: 6px;
      background: #eee;
      border-radius: 3px;
      overflow: hidden;
      margin-top: .5rem;
    }

    #energy-bar-fill {
      height: 100%;
      width: 0;
      background: #4caf50;
      transition: width .5s;
    }

    #energy-details {
      margin-top: .5rem;
      font-size: .85rem;
      color: #555;
      line-height: 1.4;
      max-height: 120px;
      overflow: auto;
    }

    .dimensions {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(3,1fr);
      background: #fff;
      padding: 1rem;
      border-top: 1px solid #eee;
      border-radius: 0 0 8px 8px;
      gap: 1rem;
    }

    .dim-card {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: .75rem;
      text-align: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

    .dim-card strong { display: block; font-size: 1.25rem; color: #222; }
    .dim-card span { font-size: .85rem; color: #666; }

    .controls {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 1.5rem;
      overflow-y: auto;
      position: relative;
      z-index: 2;
      pointer-events: auto;
    }

    .controls h2 {
      font-size: 1.5rem;
      color: #222;
      margin-bottom: 1rem;
    }

    .price-display {
      background: #f8fafc;
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1rem 0 2rem;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .price-total {
      font-size: 2rem;
      font-weight: bold;
      color: #1a202c;
      margin-bottom: 1rem;
    }

    .price-breakdown {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .price-item {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .price-item:last-child {
      border-bottom: none;
    }

    .price-label {
      color: #64748b;
    }

    .price-value {
      font-weight: 500;
      color: #1a202c;
    }

    .group { margin-bottom: 1.5rem; }
    .group h3 {
      font-size: 1.1rem;
      color: #333;
      margin-bottom: .5rem;
    }

    .options {
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
    }

    .option {
      text-align: center;
      width: 70px;
    }

    .swatch {
      width: 100%;
      aspect-ratio: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      transition: border-color .2s;
    }

    .swatch:hover { border-color: #999; }
    .swatch.selected { border-color: #006aff; }
    .swatch.selected::after {
      content: '✔';
      position: absolute;
      top: 4px;
      right: 6px;
      color: #006aff;
      font-size: 1rem;
    }

    .option-label { margin-top: .3rem; font-size: .75rem; color: #444; }
    .option-price { font-size: .7rem; color: #666; }

    .action-buttons {
      display: flex;
      gap: .75rem;
    }

    .action-buttons button {
      flex: 1;
      padding: .75rem;
      font-size: .95rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-save { background: #f0f0f0; color: #333; }
    .btn-quote { background: #006aff; color: #fff; }

    @media (max-width: 1024px) {
      #configurator { grid-template-columns: 1fr; }
      model-viewer { height: 50vh !important; min-height: 300px; }
    }

    @media (max-width: 600px) {
      model-viewer { height: 40vh !important; min-height: 200px; }
      .dimensions { grid-template-columns: 1fr; }
    }

    @keyframes drift {
      0% { transform: translateY(0) translateX(0); opacity: 0.6; }
      50% { transform: translateY(-2px) translateX(2px); opacity: 0.3; }
      100% { transform: translateY(0) translateX(0); opacity: 0.6; }
    }

    .smoke path {
      animation: drift 3s infinite ease-in-out;
    }

    .house-body {
      transition: fill 0.6s ease-in-out, stroke 0.6s ease-in-out;
    }
  </style>
</head>
<body>
  <div class="fixed-price" id="fixed-price">
    <span class="fixed-price-label">Prix TTC</span>
    <span class="fixed-price-amount" id="fixed-price-amount">170 000 €</span>
  </div>

  <div id="configurator">
    <div class="viewer-card">
      <model-viewer
        id="mv"
        src="MODERNHOME9.glb"
        alt="Maison Modern'home"
        exposure="0.6"
        shadow-intensity="2.5"
        shadow-softness="1"
        camera-controls
        min-camera-orbit="0deg 0deg auto"
        max-camera-orbit="360deg 90deg auto">
      </model-viewer>

      <div id="energy-summary">
        <h3>Performance énergétique estimée</h3>
        <div id="energy-visual">
          <div class="house-container">
            <svg class="house-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
              <path
                class="house-body"
                d="M20,70 L20,40 L50,15 L80,40 L80,70"
                fill="none"
                stroke="currentColor"
                stroke-width="6"
                stroke-linejoin="round"
                stroke-linecap="round"/>
              <path
                d="M65,30 L65,20"
                fill="none"
                stroke="currentColor"
                stroke-width="6"
                stroke-linecap="round"/>
              <g class="smoke">
                <path
                  d="M63,17 C67,15 69,13 67,11 M67,12 C71,10 73,8 71,6"
                  fill="none"
                  stroke="#999"
                  stroke-width="1"
                  stroke-linecap="round"/>
              </g>
            </svg>
          </div>

          <div class="energy-rating-scale">
            <div class="rating-bar rating-A-plus" data-rating="A+">
              <span class="rating-label">A+</span>
              <span class="rating-value">≤50</span>
            </div>
            <div class="rating-bar rating-A" data-rating="A">
              <span class="rating-label">A</span>
              <span class="rating-value">51-90</span>
            </div>
            <div class="rating-bar rating-B" data-rating="B">
              <span class="rating-label">B</span>
              <span class="rating-value">91-150</span>
            </div>
            <div class="rating-bar rating-C" data-rating="C">
              <span class="rating-label">C</span>
              <span class="rating-value">151-230</span>
            </div>
            <div class="rating-bar rating-D" data-rating="D">
              <span class="rating-label">D</span>
              <span class="rating-value">231-330</span>
            </div>
            <div class="rating-bar rating-E" data-rating="E">
              <span class="rating-label">E</span>
              <span class="rating-value">331-450</span>
            </div>
            <div class="rating-bar rating-F" data-rating="F">
              <span class="rating-label">F</span>
              <span class="rating-value">451-590</span>
            </div>
            <div class="rating-bar rating-G" data-rating="G">
              <span class="rating-label">G</span>
              <span class="rating-value">>590</span>
            </div>
          </div>
        </div>

        <div class="energy-line">
          <span>Consommation :</span>
          <span id="energy-value">120 kWh/an</span>
        </div>
        <div class="energy-line">
          <span>Classe :</span>
          <span id="energy-class">B</span>
        </div>
        <div class="energy-bar">
          <div id="energy-bar-fill"></div>
        </div>
        <h4 style="margin-top:1rem;font-size:.9rem;color:#555">Détail par matériau</h4>
        <div id="energy-details"><i>Configuration de base</i></div>
      </div>

      <div class="dimensions">
        <div class="dim-card"><strong>85 m²</strong><span>Surface</span></div>
        <div class="dim-card"><strong>3 Ch</strong><span>Chambres</span></div>
        <div class="dim-card"><strong>2 SdE</strong><span>Salles d'eau</span></div>
      </div>
    </div>

    <div class="controls">
      <h2>Configuration Modern'home</h2>

      <div class="price-display">
        <div class="price-total" id="total-price">170 000 €</div>
        <div class="price-breakdown" id="price-breakdown">
          <div class="price-item">
            <span class="price-label">Prix de base</span>
            <span class="price-value">170 000 €</span>
          </div>
        </div>
      </div>

      <div class="group" data-cat="Menuiserie">
        <h3>Menuiserie ALU</h3>
        <div class="options">
          <div class="option">
            <div class="swatch" style="background-color:#FFFFFF" data-color="#FFFFFF" data-cost="0"></div>
            <div class="option-label">Blanc</div>
            <div class="option-price">+0 €</div>
          </div>
          <div class="option">
            <div class="swatch" style="background-color:#000000" data-color="#000000" data-cost="2499"></div>
            <div class="option-label">Noir</div>
            <div class="option-price">+2 499 €</div>
          </div>
        </div>
      </div>

      <div class="group" data-cat="Gouttiere">
        <h3>Gouttière et descente</h3>
        <div class="options">
          <div class="option">
            <div class="swatch" style="background-color:#FFFFFF" data-color="#FFFFFF" data-cost="0"></div>
            <div class="option-label">Blanc</div>
            <div class="option-price">+0 €</div>
          </div>
        </div>
      </div>

      <div class="group" data-cat="Pergola">
        <h3>Pergola bioclimatique</h3>
        <div class="options">
          <div class="option">
            <div class="swatch" style="background-color:#FFFFFF" data-color="#FFFFFF" data-cost="8500"></div>
            <div class="option-label">Blanc</div>
            <div class="option-price">+8 500 €</div>
          </div>
          <div class="option">
            <div class="swatch" style="background-color:#000000" data-color="#000000" data-cost="9500"></div>
            <div class="option-label">Noir</div>
            <div class="option-price">+9 500 €</div>
          </div>
        </div>
      </div>

      <div class="group" data-cat="Murs">
        <h3>Peinture (mur extérieur)</h3>
        <div class="options">
          <div class="option">
            <div class="swatch" style="background-color:#FFFFFF" data-color="#FFFFFF" data-cost="0"></div>
            <div class="option-label">Blanc</div>
            <div class="option-price">+0 €</div>
          </div>
          <div class="option">
            <div class="swatch" style="background-color:#D4C4A3" data-color="#D4C4A3" data-cost="999"></div>
            <div class="option-label">Beige WES</div>
            <div class="option-price">+999 €</div>
          </div>
          <div class="option">
            <div class="swatch" style="background-color:#E6C7B1" data-color="#E6C7B1" data-cost="1499"></div>
            <div class="option-label">Ocre Mojave</div>
            <div class="option-price">+1 499 €</div>
          </div>
        </div>
      </div>

      <div class="group" data-cat="Toit">
        <h3>Tôle ondulée</h3>
        <div class="options">
          <div class="option">
            <div class="swatch" style="background-color:#1A2E3F" data-color="#1A2E3F" data-cost="0"></div>
            <div class="option-label">Bleu Ardoise</div>
            <div class="option-price">+0 €</div>
          </div>
          <div class="option">
            <div class="swatch" style="background-color:#A6A6A6" data-color="#A6A6A6" data-cost="0"></div>
            <div class="option-label">Gris Acier</div>
            <div class="option-price">+0 €</div>
          </div>
          <div class="option">
            <div class="swatch" style="background-color:#C0392B" data-color="#C0392B" data-cost="1800"></div>
            <div class="option-label">Rouge Hibiscus</div>
            <div class="option-price">+1 800 €</div>
          </div>
        </div>
      </div>

      <div class="price-display">
        <div class="price-total">Total TTC</div>
        <div id="detailed-price-breakdown">
          <div class="price-item">
            <span class="price-label">Prix de base</span>
            <span class="price-value">170 000 €</span>
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn-save">Enregistrer la configuration</button>
        <button class="btn-quote">Demander un devis</button>
      </div>
    </div>
  </div>

  <script>
    const energyImpact = {
      Toit: {'#1A2E3F':120,'#A6A6A6':150,'#C0392B':180},
      Pergola: {'#FFFFFF':120,'#000000':150},
      Murs: {'#FFFFFF':120,'#D4C4A3':150,'#E6C7B1':180},
      Menuiserie: {'#FFFFFF':120,'#000000':150},
      Gouttiere: {'#FFFFFF':120}
    };

    const ratingColors = {
      'Aplus': '#1B5E20',
      'A': '#2E7D32',
      'B': '#388E3C',
      'C': '#8BC34A',
      'D': '#FFEB3B',
      'E': '#FFC107',
      'F': '#FF9800',
      'G': '#F44336'
    };

    function getEnergyClass(kwh) {
      if(kwh <= 50) return 'Aplus';
      if(kwh <= 90) return 'A';
      if(kwh <= 150) return 'B';
      if(kwh <= 230) return 'C';
      if(kwh <= 330) return 'D';
      if(kwh <= 450) return 'E';
      if(kwh <= 590) return 'F';
      return 'G';
    }

    window.addEventListener('DOMContentLoaded', () => {
      const mv = document.getElementById('mv');
      const totalEl = document.getElementById('total-price');
      const fixedPriceEl = document.getElementById('fixed-price-amount');
      const energyEl = document.getElementById('energy-value');
      const classEl = document.getElementById('energy-class');
      const barFill = document.getElementById('energy-bar-fill');
      const ratingBars = document.querySelectorAll('.rating-bar');
      const houseSvg = document.querySelector('.house-svg');
      const fixedPrice = document.getElementById('fixed-price');
      const detailedPriceBreakdown = document.getElementById('detailed-price-breakdown');
      const basePrice = 170000;
      let selection = {};

      window.addEventListener('scroll', () => {
        if (window.scrollY > 100) {
          fixedPrice.classList.add('visible');
        } else {
          fixedPrice.classList.remove('visible');
        }
      });

      const targets = {
        Menuiserie: ['menui','volets'],
        Gouttiere: ['gouttiere'],
        Pergola: ['pergola'],
        Murs: ['murs'],
        Toit: ['toit']
      };

      function hex2rgba(h) {
        const v = parseInt(h.slice(1), 16);
        return [
          (v >> 16 & 255) / 255,
          (v >> 8 & 255) / 255,
          (v & 255) / 255,
          1
        ];
      }

      function updateEnergy() {
        let sum = 120, lines = [];
        Object.entries(selection).forEach(([cat]) => {
          const sw = document.querySelector(`.group[data-cat="${cat}"] .swatch.selected`);
          if(!sw) return;
          const col = sw.dataset.color;
          const imp = energyImpact[cat][col] || 120;
          sum += (imp - 120);
          if (imp !== 120) {
            lines.push(`• ${cat} – ${sw.nextElementSibling.textContent}: ${imp>120?'+':''}${imp-120} kWh/an`);
          }
        });

        energyEl.textContent = `${sum} kWh/an`;
        const cls = getEnergyClass(sum);
        classEl.textContent = cls === 'Aplus' ? 'A+' : cls;
        barFill.style.width = `${Math.min(100, Math.round(sum/590*100))}%`;

        ratingBars.forEach(bar => {
          const rating = bar.dataset.rating;
          bar.classList.toggle('active',
            (rating === 'A+' && cls === 'Aplus') || rating === cls);
        });

        houseSvg.style.color = ratingColors[cls];
        document.getElementById('energy-details').innerHTML =
          lines.length ? lines.join('<br>') : '<i>Configuration de base</i>';
      }

      function updatePriceBreakdown() {
        const items = ['<div class="price-item"><span class="price-label">Prix de base</span><span class="price-value">170 000 €</span></div>'];
        let totalOptions = 0;
        
        Object.entries(selection).forEach(([cat]) => {
          const sw = document.querySelector(`.group[data-cat="${cat}"] .swatch.selected`);
          if(!sw) return;
          const cost = +sw.dataset.cost;
          if(cost > 0) {
            const label = sw.nextElementSibling.textContent;
            totalOptions += cost;
            items.push(`
              <div class="price-item">
                <span class="price-label">${cat} - ${label}</span>
                <span class="price-value">+${cost.toLocaleString('fr-FR')} €</span>
              </div>
            `);
          }
        });
        
        items.push(`
          <div class="price-item" style="margin-top: 1rem; border-top: 2px solid #e2e8f0; padding-top: 1rem;">
            <span class="price-label">Total des options</span>
            <span class="price-value">+${totalOptions.toLocaleString('fr-FR')} €</span>
          </div>
          <div class="price-item" style="font-weight: bold; font-size: 1.1em;">
            <span class="price-label">Total TTC</span>
            <span class="price-value">${(basePrice + totalOptions).toLocaleString('fr-FR')} €</span>
          </div>
        `);
        
        document.getElementById('price-breakdown').innerHTML = items.join('');
        detailedPriceBreakdown.innerHTML = items.join('');
      }

      mv.addEventListener('load', () => {
        const mats = mv.model.materials;
        document.querySelectorAll('.group').forEach(group => {
          const cat = group.dataset.cat;
          const frags = targets[cat] || [];
          group.querySelectorAll('.swatch').forEach(sw => {
            sw.addEventListener('click', () => {
              group.querySelectorAll('.swatch').forEach(x => x.classList.remove('selected'));
              sw.classList.add('selected');
              selection[cat] = +sw.dataset.cost;
              const tot = Object.values(selection).reduce((a,b) => a+b, 0);
              const totalPrice = `${(basePrice+tot).toLocaleString('fr-FR')} €`;
              totalEl.textContent = totalPrice;
              fixedPriceEl.textContent = totalPrice;
              updatePriceBreakdown();
              const rgba = hex2rgba(sw.dataset.color);
              mats.forEach(m => {
                const name = m.name.toLowerCase();
                if(frags.some(f => name.includes(f))) {
                  m.pbrMetallicRoughness.setBaseColorFactor(rgba);
                  m.pbrMetallicRoughness.setMetallicFactor(1);
                  m.pbrMetallicRoughness.setRoughnessFactor(1);
                }
              });
              updateEnergy();
            });
          });
          const first = group.querySelector('.swatch');
          if(first) first.click();
        });
        updateEnergy();
      });
    });
  </script>
</body>
</html>